<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IKEA Manual Converter</title>
    <style>
        /* --- CSS Variables --- */
        :root {
            --blue-bg-main: #EBF5FB;      
            --blue-bg-container: #F4F9FC; 
            --blue-text-dark: #2C3E50;    
            --blue-text-medium: #546E7A;  
            --blue-accent: #5DADE2;       
            --blue-accent-hover: #3498db; 
            --blue-border-dashed: #AED6F1; 
            --blue-input-bg: #FFFFFF;
        }

        /* --- General Reset --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--blue-bg-main);
            color: var(--blue-text-dark);
            line-height: 1.6;
        }

        /* --- Header --- */
        header {
            background-color: var(--blue-bg-container);
            padding: 1rem 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #dbe8f1;
            flex-wrap: wrap; 
            gap: 1rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--blue-accent);
            display: flex;
            align-items: center;
        }
        
        .logo-icon {
            width: 24px;
            height: 24px;
            background-color: var(--blue-accent);
            margin-right: 10px;
            border-radius: 4px;
        }

        /* --- Controls --- */
        .top-nav-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* Styled Select Dropdown */
        .product-select {
            padding: 8px 12px;
            border: 2px solid var(--blue-border-dashed);
            border-radius: 8px;
            background-color: white;
            color: var(--blue-text-medium);
            font-size: 1rem;
            cursor: pointer;
            outline: none;
        }

        .product-select:focus {
            border-color: var(--blue-accent);
        }

        /* --- Hero Section --- */
        .hero-section {
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 60vh;
        }

        .converter-container {
            background-color: var(--blue-bg-container);
            width: 100%;
            max-width: 900px;
            padding: 3rem 2rem;
            border-radius: 12px;
            text-align: center;
            border: 3px dashed var(--blue-border-dashed);
            box-shadow: 0 4px 15px rgba(93, 173, 226, 0.1);
            margin-bottom: 2rem;
        }

        .main-icon {
            font-size: 3rem;
            color: var(--blue-accent);
            margin-bottom: 1rem;
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 0.5rem;
            color: var(--blue-text-dark);
        }

        .subtitle {
            font-size: 1.1rem;
            color: var(--blue-text-medium);
            margin-bottom: 2rem;
        }

        #file-upload { display: none; }

        .big-upload-button {
            display: inline-block;
            background-color: var(--blue-accent);
            color: white;
            padding: 1rem 3rem;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(93, 173, 226, 0.3);
            border: none;
        }

        .big-upload-button:hover {
            background-color: var(--blue-accent-hover);
            transform: translateY(-2px);
        }
        
        .big-upload-button:disabled {
            background-color: #BDC3C7;
            cursor: not-allowed;
            transform: none;
        }

        /* --- Results Area --- */
        #results-area {
            width: 100%;
            max-width: 900px;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            display: none; /* Hidden by default */
        }

        .results-header {
            font-size: 1.5rem;
            color: var(--blue-accent);
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--blue-bg-main);
            padding-bottom: 0.5rem;
        }

        .instruction-text {
            white-space: pre-wrap; /* Preserves newlines */
            font-family: 'Courier New', Courier, monospace;
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #eee;
            color: #333;
        }
        
        .loading {
            color: var(--blue-accent);
            font-weight: bold;
            display: none;
            margin-top: 1rem;
        }

    </style>
</head>
<body>

    <header>
        <div class="logo">
            <div class="logo-icon"></div>
            IKEA Text Extractor
        </div>

        <div class="top-nav-controls">
            <select id="product-dropdown" class="product-select">
                <option value="" disabled selected>Select a Product...</option>
                </select>
        </div>
    </header>

    <main class="hero-section">
        <div class="converter-container">
            <div class="main-icon">ðŸ“„</div>
            <h1>IKEA Manual to Text Converter</h1>
            <p class="subtitle">Select a product from the top menu OR upload a new PDF.</p>

            <input type="file" id="file-upload" accept=".pdf">
            <label for="file-upload" class="big-upload-button">
                Upload New File
            </label>
            <div id="loading-msg" class="loading">Processing... please wait (this may take a minute)</div>
        </div>

        <div id="results-area">
            <div class="results-header" id="result-title">Instructions</div>
            <div class="instruction-text" id="instruction-content"></div>
        </div>
    </main>

    <footer>
        <p>Â© 2025 IKEA Text Extractor Project.</p>
    </footer>

    <script>
        const API_URL = "http://localhost:8000"; 

        // 1. Fetch Products on Load
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch(`${API_URL}/products`);
                const products = await response.json();
                
                const dropdown = document.getElementById('product-dropdown');
                
                products.forEach(prod => {
                    const option = document.createElement('option');
                    option.value = prod.product_name;
                    option.textContent = `${prod.category}: ${prod.product_name}`;
                    dropdown.appendChild(option);
                });

                // Dropdown Event Listener
                dropdown.addEventListener('change', async (e) => {
                    const productName = e.target.value;
                    await fetchManualText(productName);
                });

            } catch (err) {
                console.error("Error fetching products:", err);
            }
        });

        // 2. Fetch Text from DB (via Dropdown)
        async function fetchManualText(productName) {
            showLoading(true);
            try {
                const response = await fetch(`${API_URL}/manual-text?product_name=${encodeURIComponent(productName)}`);
                const data = await response.json();
                
                if (response.ok) {
                    displayResults(data.product_name, data.instructions);
                } else {
                    alert("Error: " + data.detail);
                }
            } catch (err) {
                alert("Failed to fetch instructions.");
                console.error(err);
            } finally {
                showLoading(false);
            }
        }

        // 3. Handle File Upload
        const fileInput = document.getElementById('file-upload');
        fileInput.addEventListener('change', async () => {
            const file = fileInput.files[0];
            if (!file) return;

            showLoading(true);
            const formData = new FormData();
            formData.append("file", file);

            try {
                const response = await fetch(`${API_URL}/process-manual`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (response.ok) {
                    displayResults(data.filename, data.instructions);
                } else {
                    alert("Processing Error: " + data.detail);
                }
            } catch (err) {
                alert("Failed to process file.");
                console.error(err);
            } finally {
                showLoading(false);
                fileInput.value = ''; // Reset input
            }
        });

        // Helper Functions
        function showLoading(isLoading) {
            const loader = document.getElementById('loading-msg');
            loader.style.display = isLoading ? 'block' : 'none';
        }

        function displayResults(title, text) {
            const area = document.getElementById('results-area');
            const titleElem = document.getElementById('result-title');
            const contentElem = document.getElementById('instruction-content');

            area.style.display = 'block';
            titleElem.textContent = "Instructions for: " + title;
            // Handle if text is null or empty
            contentElem.textContent = text || "No text instructions generated yet.";
            
            // Scroll to results
            area.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>